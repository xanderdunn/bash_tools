# YubiKey GPG and SSH

## Goal
We want to be able to:
- :white_check_mark: GPG-sign all GitHub commits
- :white_check_mark: Execute remote git commands via `git@` ssh URLs for private repositories
- :white_check_mark: SSH into remote instances

You will need a [YubiKey 5C](https://www.yubico.com/product/yubikey-5c-nfc/) for this guide. If you don't have one please reach out to IT who will be able to provide you with one. [YubiKey C Bio](https://www.yubico.com/product/yubikey-c-bio/) is **not** compatible with this!

For security, all private keys are generated on the YubiKey and never leave the YubiKey. For this reason:
- We do not create backups of the secret key material generated by YubiKeys. In the event of a lost YubiKey, you should revoke the old public keys associated with the lost device and register a new YubiKey.
- We do not import externally generated keys into the YubiKey

## GPG
- Install the necessary dependencies
    - On macOS, switch your default shell to bash:
        - `brew install bash`
        - `chsh -s /opt/homebrew/bin/bash`
        - Create the file `~/.bash_profile` and add to it: `[ -r ~/.bashrc ] && source ~/.bashrc`. This will make all the additions to ~/.bashrc later in this doc take effect on macOS
        - If you skip this step, you're not using the canonical dev environment and you're on your own to figure it out in the shell that you're using.
    - macOS:
        - `brew install gnupg yubikey-personalization hopenpgp-tools ykman pinentry wget pinentry-mac`
    - On Ubuntu:
        - If you're on Ubuntu 18.04, upgrade to 20.04 unless you have a very good reason not to. 18.04 loses its Long Term Support (LTS) in April 2023, which means no more security patches. Furthermore, it's missing a lot of the security features described below in this document, and upgrading GnuPG to take advatnage of those features is very time consuming.
        - `sudo apt update`
        - `sudo apt -y install wget gnupg2 gnupg-agent dirmngr cryptsetup scdaemon pcscd secure-delete hopenpgp-tools yubikey-personalization`
        - `sudo apt -y install libssl-dev swig libpcsclite-dev`
        - Install the ykman utility:
        ```
        sudo apt-add-repository ppa:yubico/stable
        sudo apt update
        sudo apt install yubikey-manager
        sudo service pcscd start
        # If ykman still doesn't work when you use it below, do a restart
        ykman --version
        # You should see version 4.0.8 or higher, version 3 does not work with some of the commands in this doc
        ```
- Plug-in the YubiKey to your machine
- `gpg --card-edit`, and it should show your YubiKey:
```
Reader ...........: Yubico YubiKey OTP FIDO CCID
...
```
- Enter `admin` in the prompt to enable administrator commands: `gpg/card> admin`
- If you're on macOS or Ubuntu 20.04+, an easy layer of additional security: Enable KDF (PIN hashing): `gpg/card> kdf-setup`, and enter the default admin password `12345678`
    - This makes the YubiKey store only a hash of the PIN you'll set in the next step, rather than the plaintext PIN
    - `gpg --version` will need to show 2.2.20 or higher for this command to be present, so it doesn't work on Ubuntu 18.04. Upgrading GnuPG on Ubuntu 18.04 is a lot of pain. Prefer upgrading to Ubuntu 20.04.
- Change the admin PIN from its default value:
    - `gpg/card> admin`
    - `gpg/card> passwd`
    - `gpg/card> 3`
    - Enter `12345678`, as this is the default admin PIN
    - Now you will enter your password twice. It MUST be 8 characters minimum. It can have any ASCII character in it. Max 127 characters.
    - Be warned that if you enter this password incorrectly 3 times in a row, you will never again be able to run admin commands on this instance of the OpenPGP smart card. That means to regain admin access you will have to wipe all the keys on the card and reset to factory settings with `ykman openpgp reset`.
- Change the user PIN from its default value:
    - `gpg/card> passwd`
    - `gpg/card> 1`
    - The default password is `123456`
    - The same rules apply as the admin password, except that getting it wrong three times does not destroy the card.
- Set the touch policy of the YubiKey:
    - `ykman openpgp keys set-touch enc cached`
    - `ykman openpgp keys set-touch aut cached`
    - `ykman openpgp keys set-touch sig cached`
    - We choose this touch policy to prevent a disaster scenario such as [this](https://matrix.org/blog/2019/05/08/post-mortem-and-remediations-for-apr-11-security-incident#ssh-config-should-be-hardened-disabling-unnecessary-options) where an intruder silently uses your SSH key during the PIN cache period without your knowledge.
    - **Please set this before proceeding, because setting it later will invalidate the keys**
- On macOS and Ubuntu 20.04+ Set the type of GPG keys we will be creating
    - `gpg/card> key-attr`
    - **You will receive SIX prompts, choosing ECC and Curve 25519 for each of them:**
        - (2) ECC
        - (1) Curve 25519 *default*
        - Enter your admin password
        - (2) ECC
        - (1) Curve 25519 *default*
        - Enter your admin password
        - (2) ECC
        - (1) Curve 25519 *default*
        - Enter your admin password
- Now finally create the GPG key: `gpg/card> generate`
    - When asked whether to export an off-card backup, the answer is NO. **Do not store an off-card backup of your key**. That defeats the purpose of using a YubiKey here. It's trivial to replace lost SSH and GPG keys. Do not ever export your Yubikey keys off the card.
    - Do NOT choose `0 = key does not expire` for the expiration date. All GPG keys should have a finite lifespan. I chose `90` days. It's very easy to recreate GPG keys after following this guide once, doing this every 3-6 months is very reasonable.
    - The email you put in here MUST be the same as the email you use to commit to GitHub
    - Enter the user PIN, not the admin PIN
- Now you can exit the gpg card prompt: `gpg/card> quit`
- This new GPG public key is now listed in your local GPG keyring: `gpg --list-keys`
- If you have more than one key, find the one you just created, and copy the ID shown, such as:
```
pub   ed25519 2022-04-25 [SC] [expires: 2022-07-24]
      4F6430E08EF00050EA458DC2BD5B086AE03EB5B0
```
- Export the public key: `gpg --armor --export 4F6430E08EF00050EA458DC2BD5B086AE03EB5B0 > gpg.pub`
- [Add this GPG key in your GitHub settings](https://docs.github.com/en/authentication/managing-commit-signature-verification/adding-a-gpg-key-to-your-github-account) and note the `Key ID: 01BECFA3C1AE191D15` value it shows, use it in the next step
- Setup git commit GPG signing
    - `git config --global user.signingkey 01BECFA3C1AE191D15`
    - `git config --global commit.gpgsign true` # Default to GPG signing all commits
    - Make sure your git email matches your GPG email: `git config --global user.email "MY_NAME@avalabs.org"`
    - :white_check_mark: Test it out in a repo: `git commit -m "THE COMMIT MESSAGE"`. If your key is not connected, it will ask you to connect it. Then you will enter your PIN. **The YubiKey will flash its light and you tap it. You will have to tap it every time you use it, remember to tap it! You will have to tap it even if you aren't prompted for your PIN.**

## Choosing an SSH Method
Below you will find two ways of creating an SSH key on your YubiKey: Using GPG, or using ED25519-SK. Both methods will create a new SSH key on your YubiKey and give you a new SSH public key. Unless you **really** know what you're doing, just use the GPG method and completely skip and ignore the ED25519-SK method.

## SSH with GPG
This method of using GPG for SSH is older and widely supported. With it, you will be able to SSH into remote Ubuntu 18.04/20.04 instances, as well as do GitHub SSH clone/pull/push commands.
- Add to your ~/.bashrc:
```
export GPG_TTY="$(tty)"
export SSH_AUTH_SOCK=$(gpgconf --list-dirs agent-ssh-socket)
gpg-connect-agent updatestartuptty /bye > /dev/null
```
- Create the file `$HOME/.gnupg/gpg-agent.conf` and populate it with:
```
# https://www.gnupg.org/documentation/manuals/gnupg/Agent-Options.html
enable-ssh-support
ttyname $GPG_TTY
default-cache-ttl 60
max-cache-ttl 120
pinentry-program /usr/bin/pinentry-curses
```
On macOS that last line should be replaced with `pinentry-program /usr/local/bin/pinentry-mac` for Intel Macs, `pinentry-program /opt/homebrew/bin/pinentry-mac` for ARM/Apple Silicon Macs or `pinentry-program /usr/local/MacGPG2/libexec/pinentry-mac.app/Contents/MacOS/pinentry-mac` if using MacGPG Suite.

- Add to `~/.ssh/config` to ensure that the pinetry-curses appears in the right terminal: `Match host * exec "gpg-connect-agent UPDATESTARTUPTTY /bye"`
- Kill the agent so that configuration changes take effect on next start: `gpgconf --kill gpg-agent`
- Now open a new shell, or `source ~/.bashrc` for the changes we added above to take effect
- With your YubiKey connected, `ssh-add -L` should show your YubiKey
- GitHub
  - :white_check_mark: Copy the public key from `ssh-add -L`. In this example the public key is `ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAztWqZ3U9Fthi3NHnThRj7Li8GcQliYVTWmFBGAyHjL`:

        ssh-add -L
        ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAztWqZ3U9Fthi3NHnThRj7Li8GcQliYVTWmFBGAyHjL cardno:19 145 116

  - :white_check_mark: [Upload the public key to your GitHub settings](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account) and test it on a private repository: `git clone git@github.com:ava-labs/MY_REPO`. If your YubiKey isn't connected, this will just fail. Once it's connected, enter your PIN and then tap the YubiKey.
  - :white_check_mark: The Ava Labs github organization has enabled SAML SSO. [Authorize the SSH key for use with SAML single sign-on](https://docs.github.com/en/enterprise-cloud@latest/authentication/authenticating-with-saml-single-sign-on/authorizing-an-ssh-key-for-use-with-saml-single-sign-on). ![configure sso](/assets/configure-sso.png)
- Remote Machine SSH
    - Note that [AWS supports ED25519 SSH keys](https://aws.amazon.com/about-aws/whats-new/2021/08/amazon-ec2-customers-ed25519-keys-authentication/). However, [Azure does not](https://docs.microsoft.com/en-us/troubleshoot/azure/virtual-machines/ed25519-ssh-keys). This means that Azure's UI will not allow creating an instance with an ED25519 key, but an ED25519 key can still be manually put into an instance's ~/.ssh/authorized_keys file and that works.
    - Before throwing away your previous SSH keys, SSH into any instance you need to have access to and copy your public key shown by `ssh-add -L` to ~/.ssh/authorized_keys
    - :white_check_mark: Test it with `ssh MY_USER@REMOTE_IP`. It should default to trying the GPG agent's SSH key first, which will fail if the YubiKey is not connected. If the YubiKey is connected you should be prompted for your PIN and then tap the flashing light.

## SSH with ED25519-SK
This method is newer than the GPG method and doesn't require hijacking ssh-agent, but because it's new it's not supported on older systems. For example, you will be unable to SSH into remote Ubuntu 18.04 machines with this type of SSH key! However, it does work for GitHub SSH as well as SSH into remote Ubuntu 20.04 machines. **If the SSH with GPG method is working for you, skip this, you're done!**
- Creating the FIDO ECC keys requires OpenSSH 8.2+, check with `ssh -V`
    - macOS
        - `brew install openssh`
        - `export PATH=$(brew --prefix openssh)/bin:$PATH`
        - `ssh -V` should show `OpenSSH_9.0p1` or later
    - Ubuntu 20.04 should come with OpenSSH 8.2
    - Ubuntu 18.04 isn't going to work, just upgrade to 20.04.
- Now generate the key on the YubiKey: `ssh-keygen -t ed25519-sk`
    - You MUST add a passphrase to this generated SSH key
- Set this new key as your default SSH key:
    - In `~/.ssh/config`: `IdentityFile /home/MY_USER/.ssh/id_ed25519_sk`
- GitHub
    - :white_check_mark: Now add the id_ed25519_sk.pub to your GitHub settings and test it on a private repository: `git clone git@github.com:ava-labs/MY_REPO`. If your YubiKey isn't connected, this will just fail. Once it's connected, enter your SSH key passphrase and then tap your YubiKey.
- Remote Machine SSH
    - Before throwing away your previous SSH keys, SSH into any instance you need to have access to and add your new id_ed25519_sk.pub to ~/.ssh/authorized_keys
    - Now you should be able to SSH into your instance with your new `id_ed25519_sk` key
        - :white_check_mark: `ssh -i ~/.ssh/id_ed25519_sk MY_USER@REMOTE_IP` works without installing any packages or changing any configurations when `REMOTE_IP` is an Ubuntu 20.04 instance
        - **Remember to remove your old SSH public key** from ~/.ssh/authorized_keys once you've verified that your new one works!
        - Note that [AWS supports ED25519 SSH keys](https://aws.amazon.com/about-aws/whats-new/2021/08/amazon-ec2-customers-ed25519-keys-authentication/). However, [Azure does not](https://docs.microsoft.com/en-us/troubleshoot/azure/virtual-machines/ed25519-ssh-keys). This means that Azure's UI will not allow creating an instance with an ED25519 key, but an ED25519 key can still be manually put into an instance's ~/.ssh/authorized_keys file and that works.

## SSH and GPG Agent Forwarding
With the above GPG instructions you can do SSH actions and GPG signatures on your local machine, but what if you need to work with code while SSHed into a remote machine? Agent forwarding allows this:
- You must have OpenGPG version 2.1+ on both the local and remote machines
- I found the pinentry-ncurses key capture worked poorly when done on top of an SSH tunnel on macOS, so in `~/.gnupg/gpg-agent.conf` I set `pinentry-program /opt/homebrew/bin/pinentry-mac`, which reliably captures the keyboard. The Ubuntu equivalent would be `pinentry-program /usr/bin/pinentry-gtk-2`. Ensure that it is installed first using `sudo apt-get install pinentry-gtk-2`. Once that is set, restart the gpg-agent using `gpg-connect-agent updatestartuptty /bye`.
- SSH into the remote: `ssh MY_USER@REMOTE_IP`
    - In `/etc/ssh/sshd_config` set `StreamLocalBindUnlink yes`, and verify its validity with `sudo sshd -t`, it should print nothing if it's valid. Then restart sshd with `sudo service sshd restart`
    - `mkdir ~/.gnupg`
- Copy your public key to the remote machine: `rsync ~/.gnupg/pubring.kbx MY_USER@REMOTE_IP:~/.gnupg/`
    - OpenSSH [considers scp to be outdated and obsolete](https://www.openssh.com/txt/release-8.0) and recommends using rsync instead
- Set the correct permissions on the created folder and file:
    - `chown -R $(whoami) ~/.gnupg/`
    - `chmod 600 ~/.gnupg/*`
    - `chmod 700 ~/.gnupg`
- Now on the remote instance you should see the key appear in the keyring: `gpg --list-keys`.
- Now close your previous SSH session with the remote, and open a new one with agent forwarding: `ssh -A MY_USER@REMOTE_IP`
    - With your YubiKey plugged in locally, you should also see your SSH public key when you do `ssh-add -L` on the remote machine.
- :white_check_mark: Test that you can now clone a private repository on the remote machine: `git clone git@github.com:ava-labs/MY_REPO`
- On your local machine, configure GPG agent forwarding: Edit `~/.ssh/config` and add:
    - Replace `<REMOTE_IP>` with the IP address of the remote machine you're SSHing into.
    - On your remote machine, run `gpgconf --list-dir agent-socket` and replace `<REMOTE_SOCKET>` with that value
    - On your local machine, run `gpgconf --list-dir agent-extra-socket` and replace `<LOCAL_SOCKET>`
```
Host <REMOTE_IP>
   ForwardAgent yes
   Compression yes
   ForwardX11 no
   RemoteForward <REMOTE_SOCKET> <LOCAL_SOCKET>
   ServerAliveInterval 100 # Send a NULL message every 100 seconds to keep the connection alive
```
- Configure git as you did on your local machine:
    - `git config --global user.signingkey 01BECFA3C1AE191D15`
    - `git config --global commit.gpgsign true` # Default to GPG signing all commits
    - Make sure your git email matches your GPG email: `git config --global user.email "MY_NAME@avalabs.org"`
- `exit` the ssh session and start it again so that the `~/.ssh/config` settings take effect
- On the remote machine, when you SSH in you should now see your GPG secret key listed: `gpg --list-secret-keys`
- :white_check_mark: Test that you can now sign a commit on the remote machine: `git commit -m "MESSAGE"`
- In addition to the above, it is strongly recommended that you harden your SSH configuration on your remote machine. With `sudo` privileges, edit `/etc/ssh/sshd_config` and set:
```
UsePAM yes # This must be set to yes to be able to SSH in with a public key
PermitRootLogin no
MaxAuthTries 3
LoginGraceTime 20
PasswordAuthentication no
PermitEmptyPasswords no
ChallengeResponseAuthentication no
KerberosAuthentication no
GSSAPIAuthentication no
X11Forwarding no
PermitUserEnvironment no
#AcceptEnv LANG LC_* # This needs to be commented out
AllowTcpForwarding yes # Must be yes on Ubuntu 20 or if you're SSHing from Visual Studio Code
PermitTunnel no
DebianBanner no
StrictModes yes
AllowUsers MY_USER
MaxSessions 2
PubkeyAuthentication yes
PubkeyAcceptedKeyTypes ssh-ed25519 # Whatever key type you generated above
# To keep the connection alive: https://unix.stackexchange.com/a/200256
ClientAliveInterval 60
TCPKeepAlive yes
ClientAliveCountMax 100
```
Make sure to replace `MY_USER` with your remote username
- Verify that the changes are valid: `sudo sshd -t`, this should output nothing if it's valid.
- Restart sshd: `sudo service sshd restart`
- Confirm that you can still SSH into the instance

## Google Advanced Protection Program
If you have two YubiKeys, it's required that you enable Google's Advanced Protection Program, which adds additional protections against phishing and nation state attackers. Go [here](https://landing.google.com/advancedprotection/) and click "Get started" to set it up. Note that the YubiKey 5C NFC has an NFC chip and enables authentication on the iPhone in a contactless manner. When Google Gmail or Calendar asks for the YubiKey for authentication, you need to hold it near the back of the iPhone.

## Ubuntu Password Manager
- Some programs on Ubuntu, such as `docker login`, store passwords using a GPG password manager. You can use your YubiKey's GPG key for this
- `sudo apt-get install -y pass`
- Set the trust level on your YubiKey's public key
    - `gpg --list-keys` to get the ID
    - `gpg edit-key <ID>`
        - `trust`
        - `5`
        - `y`
        - `quit`
- `pass init <ID>`

## Yubikey OPSEC
- Remove the Yubikey from your computer when not in use
- When traveling with your laptop, do not keep the Yubikey in the laptop bag. Instead, carry it on your person (e.g. in your wallet, on a keychain or lanyard)
- If you have more than one Yubikey
    - Make sure they are clearly labeled so that you can tell which is which
    - Set the admin password as soon as you receive them (even if one is used as backup)
    - The backup Yubikey should be stored in a secure location, ideally in a locked safe.

## Troubleshooting
- If GPG signing is failing, try a simple GPG sign like `echo "test" | gpg --clearsign` to see what the error is
- Troubleshooting steps [here](https://github.com/drduh/YubiKey-Guide#troubleshooting)
- `gpg failed to sign the data` troubleshooting [here](https://gist.github.com/paolocarrasco/18ca8fe6e63490ae1be23e84a7039374#solutions)
    - One potential reason for this is an expired GPG key. Run `gpg --list-secret-keys` and check for `[expired:` in the top right. See below for extending an expired key.
- GPG SSH Troubleshooting [here](https://blog.summercat.com/using-a-yubikey-for-ssh-authentication.html)
- GPG Agent Forwarding Troubleshooting [here](https://github.com/drduh/YubiKey-Guide/issues/85)
    - After changing configurations, make sure the changes have taken effect by restarting the gpg agent both on your local and remote machines:
        - `gpgconf --kill gpg-agent`
        - `gpg-connect-agent updatestartuptty /bye`
- GPG SSH Troubleshooting
    - Make sure to clear out anything in your ~/.bashrc that might be overwriting or conflicting with the values that we are trying to set.
    - `echo $GPG_TTY` should produce `/dev/ttys002`, or a similar number.
    - `echo $SSH_AUTH_SOCK` should produce `/home/MY_USER/.gnupg/S.gpg-agent.ssh`
- I don't use bash, what about zsh? The above instructions have worked for several people using zsh on Ubuntu 20.04. You should be able to do the same thing, but use ~/.zshrc rather than ~/.bashrc. Some zsh plugins may require additional effort for compatibility. See for example [here](https://unix.stackexchange.com/a/608921).
- If you're hitting an error similar to: `sign_and_send_pubkey: signing failed for ED25519 "cardno:000619225233" from agent: agent refused operation`:
    - First ensure your SSH key has been added by running `ssh-add`. Run `ssh-add -l` to confirm you see your public key.
    - If that doesn't work, it is likely an issue with unlocking your card using your pin. Try using `pinentry-gtk2` by doing the following
    - ```
         sudo apt-get install pinentry-gtk2
         # Add this following line to ~/.gnupg/gpg-agent.conf
         pinentry-program /usr/bin/pinentry-gtk-2
         gpg-connect-agent updatestartuptty /bye```
- If you are having issues with `ansible` or any other tools establishing  multiple ssh connections at the same time, these issues can be caused by too much pressure put on Yubikey. Please use concurency carefully. For example: for ansible you can use `forks = 10` in `[defaults]` section of `/etc/ansible/ansible.cfg` or `-f 10` parameter. Please note that `10` is a subjective number that works for some machine. YMMV
- To extend the expiration date of a key:
    - `gpg --list-keys`
    - `gpg --edit-key <key id>`
    - `> key 1`
    - `> expire`, and set the expiration
    - `> save`
    - Then repeat the above for the two subkeys. You'll see the subkey's IDs from the above print outs and edit them with `gpg --edit-key <sub key id>`

## Resources
- [Cheatsheet](https://debugging.works/blog/yubikey-cheatsheet/#openpgp-with-yubikey)
- If you created a GPG key that you have replaced and no longer need, you can remove it from your local keyring:
    - `gpg --list-keys` and look for the name, spaces and all
    - `gpg --delete-secret-key NAME`, it will ask you which one you want to delete
        - Example: `gpg --delete-secret-key Xander Dunn`
    - `gpg --delete-key NAME`
- Very detailed YubiKey Guide [here](https://github.com/drduh/YubiKey-Guide#ssh)
- [Yubikey GPG Instructions](https://support.yubico.com/hc/en-us/articles/360013790259-Using-Your-YubiKey-with-OpenPGP)
    - Do NOT use the section titled `Generating Keys externally from the YubiKey` in this guide, go down to the `Generating Your PGP Key directly on Your YubiKey` section
- [macOS latest OpenSSH](https://stackoverflow.com/questions/68573454/having-difficulty-to-get-ssh-with-a-yubikey-working-with-macos-monterey)
- Elliptic curve safety information [here](https://safecurves.cr.yp.to/), which is why we choose ED25519 for all of the keys we generate here.
- Details on KDF [here](https://developers.yubico.com/PGP/YubiKey_5.2.3_Enhancements_to_OpenPGP_3.4.html)
- [ED25519-SK SSH setup](https://cryptsus.com/blog/how-to-configure-openssh-with-yubikey-security-keys-u2f-otp-authentication-ed25519-sk-ecdsa-sk-on-ubuntu-18.04.html)
- [OpenSSH Configure Options](https://github.com/openssh/openssh-portable#build-time-customisation)
- [OpenSSH Release Binaries](https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/)
- GPG Agent Forwarding
    - Short howto [here](https://gist.github.com/surhudm/a741f79789a5e96dd142695554ee06f5)
    - Good howto [here](https://www.ecliptik.com/Forwarding-gpg-agent-over-SSH/)
    - Longer guide [here](https://github.com/drduh/YubiKey-Guide#remote-machines-gpg-agent-forwarding)
    - Review SSH agent forwarding security considerations [here](https://matrix.org/blog/2019/05/08/post-mortem-and-remediations-for-apr-11-security-incident#ssh-agent-forwarding-should-be-disabled)
- SSH Hardening [here](https://www.digitalocean.com/community/tutorials/how-to-harden-openssh-on-ubuntu-18-04)

## Blocked PIN
If you've entered your PIN incorrectly too many times:
```
ykman piv access unblock-pin
gpg --card-edit
admin
passwd
unblock pin
```
- Increase the number of allowed PIN retries:
- Increase the timeout until you have to re-enter your PIN:
